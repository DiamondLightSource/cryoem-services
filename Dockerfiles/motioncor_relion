# This Dockerfile is used for Relion's own motion correction and Relion postprocessing
# Needs to be built on an image built with the common Relion Dockerfile
FROM rockylinux:8

# Create EM user
ARG groupid
ARG userid
ARG groupname
ARG relionbuild
RUN groupadd -r -g "${groupid}" "${groupname}" && useradd -r -M "${groupname}" -u "${userid}" -g "${groupname}"

# Install libraries for Relion
RUN yum install openmpi fftw-devel libtiff-devel libpng-devel libjpeg-devel python3.11 zlib-devel -y

# Copy Relion
COPY --from="${relionbuild}" --chown="${userid}":"${groupid}" /install/relion5.0 /install/relion5.0
ENV PATH="/install/relion5.0/bin:${PATH}"

# Make the python virtual environment and install cryoem-services
ENV VIRTUAL_ENV=/venv
RUN python3.11 -m venv $VIRTUAL_ENV
ENV PATH="$VIRTUAL_ENV/bin:$PATH"
RUN python3.11 -m pip install cryoemservices
