# This Dockerfile is used for the services that can run on CPU
FROM docker.io/library/python:3.11-slim-bookworm as base

# Install Vim in base image
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get install -y --no-install-recommends \
        vim \
        && \
    apt-get autoremove && \
    rm -rf /var/lib/apt/lists/*

# Build CryoEM Services, pipeliner, and IMOD in a branch image
FROM base as build

# Set up build arguments for this stage
ARG IMOD_INSTALLER=imod_5.1.9_RHEL8-64_CUDA12.0.sh

COPY ./ /cryoem-services/
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get install -y --no-install-recommends \
        build-essential \
        busybox \
        curl \
        net-tools \
        && \
    busybox --install && \
    python -m venv /venv && \
    /venv/bin/python -m pip install --upgrade \
        pip \
        build \
        && \
    /venv/bin/python -m pip install \
        /cryoem-services \
        http://gitlab.com/stephen-riggs/ccpem-pipeliner/-/archive/diamond_tomo/ccpem-pipeliner-diamond_tomo.zip \
        && \
    if [ ! -f /cryoem-services/installers/${IMOD_INSTALLER} ]; then \
        echo "IMOD installer not found; downloading..."; \
        curl https://bio3d.colorado.edu/imod/AMD64-RHEL5/${IMOD_INSTALLER} > /cryoem-services/installers/${IMOD_INSTALLER}; \
    fi && \
    chmod +x /cryoem-services/installers/${IMOD_INSTALLER} && \
    mkdir imod && \
    /cryoem-services/installers/${IMOD_INSTALLER} -dir imod -skip -y

# Transfer completed build to base image
FROM base

ARG groupid
ARG userid
ARG groupname

# Copy completed builds across and set user and group permissions
COPY --from=build /venv/ /venv/
COPY --from=build /imod/ /imod/
RUN groupadd -r -g "${groupid}" "${groupname}" && \
    useradd -r -M "${groupname}" -u "${userid}" -g "${groupname}" && \
    chown -R "${userid}":"${groupid}" /venv && \
    chmod -R a+x /venv
ENV PATH=/venv/bin:/imod/IMOD/bin:$PATH
ENV IMOD_DIR=/imod/IMOD
USER "${userid}":"${groupid}"
